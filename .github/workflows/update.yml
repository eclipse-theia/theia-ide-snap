name: Update

on:
  schedule:
    - cron: '48 23 * * *'
  workflow_dispatch:

jobs:
  update:
    name: Check Version
    runs-on: ubuntu-latest
    steps:
     - name: Fetch latest version
       id: latest
       run: |
         curl -L -o latest-linux.yml https://download.eclipse.org/theia/ide/latest/linux/latest-linux.yml
         VERSION=$(yq eval '.version' latest-linux.yml)
         echo "version=$VERSION" >> $GITHUB_OUTPUT

     - name: Checkout Repository
       uses: actions/checkout@v4

     - name: Update manifest
       id: manifest
       env:
         GH_TOKEN: ${{ github.token }}
       run: |
         yq eval -i '.version = "${{ steps.latest.outputs.version }}"' snap/snapcraft.yaml
         
         # Debug: Print the exact command being executed for second yq command
         echo "=== EXECUTING SECOND YQ COMMAND ==="
         echo "yq eval -i '.parts.theia-ide.source = \"https://download.eclipse.org/theia/ide/${{ steps.latest.outputs.version }}/linux/TheiaIDE.deb\"' snap/snapcraft.yaml"
         
         # Debug: Verify the path exists in the YAML file
         echo "=== CHECKING YQ PATH ==="
         yq eval '.parts.theia-ide.source' snap/snapcraft.yaml
         
         # Second yq command with error handling
         yq eval -i '.parts.theia-ide.source = "https://download.eclipse.org/theia/ide/${{ steps.latest.outputs.version }}/linux/TheiaIDE.deb/test"' snap/snapcraft.yaml
         YQ_EXIT_CODE=$?
         
         if [ $YQ_EXIT_CODE -ne 0 ]; then
           echo "Second yq command failed with exit code $YQ_EXIT_CODE"
           # Alternative approach if the command fails
           echo "Trying alternative approach with sed"
           sed -i "s|source: https://download.eclipse.org/theia/ide/.*/linux/TheiaIDE.deb|source: https://download.eclipse.org/theia/ide/${{ steps.latest.outputs.version }}/linux/TheiaIDE.deb|g" snap/snapcraft.yaml
         else
           echo "Second yq command succeeded"
         fi
         
         # Debug: Show the file after changes
         echo "=== AFTER CHANGES ==="
         cat snap/snapcraft.yaml
         
         git add snap/snapcraft.yaml
         git diff-index --exit-code HEAD || echo "changes=true" >> $GITHUB_OUTPUT

     - name: Submit pull request
       if: steps.manifest.outputs.changes == 'true'
       env:
         GH_TOKEN: ${{ github.token }}
       run: |
         git config --local user.email "actions@github.com"
         git config --local user.name "GitHub Actions"
         git commit -m "Update to version ${{ steps.latest.outputs.version }}"
         git branch ${{ steps.latest.outputs.version }}
         git checkout ${{ steps.latest.outputs.version }}
         git push origin ${{ steps.latest.outputs.version }} --set-upstream
         gh pr create --fill
